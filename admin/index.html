<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Baby Vinilo — Admin</title>

    <!-- Widget de login de Netlify Identity -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
      #msg { padding: 20px; }
    </style>
  </head>
  <body>
    <div id="msg">Cargando panel…</div>

    <script>
      // Carga un script con callback de onload y onerror
      function loadScript(src, cb, errcb){
        var s = document.createElement('script');
        s.src = src;
        s.onload = cb;
        s.onerror = errcb || function(){};
        document.head.appendChild(s);
      }

      // Intentamos primero jsDelivr (v2). Si falla, probamos unpkg (v2).
      var triedFallback = false;
      function startCMS(){
        try{
          if (window.CMS && typeof window.CMS.init === 'function'){
            window.CMS.init({ config: { load_config_file: true } });
            document.getElementById('msg').remove();
          }else{
            document.getElementById('msg').textContent = 'No se pudo cargar Netlify CMS (aún). Reintentando…';
            // Espera breve y reintenta por si el navegador tenía el script en caché
            setTimeout(startCMS, 100);
          }
        }catch(e){
          document.getElementById('msg').textContent = 'Error iniciando CMS: ' + e.message;
        }
      }

      function loadCMSFromJsDelivr(){
        loadScript(
          // cache-busting ?v=3 para evitar versiones en memoria
          'https://cdn.jsdelivr.net/npm/netlify-cms@2.10.192/dist/netlify-cms.js?v=3',
          startCMS,
          function(){
            if(!triedFallback){
              triedFallback = true;
              loadCMSFromUnpkg();
            }
          }
        );
      }

      function loadCMSFromUnpkg(){
        loadScript(
          'https://unpkg.com/netlify-cms@2.10.192/dist/netlify-cms.js?v=3',
          startCMS,
          function(){
            document.getElementById('msg').textContent = 'No se pudo cargar Netlify CMS desde los CDNs.';
          }
        );
      }

      // Re-cargar tras login de Identity (si entras desde el correo de invitación)
      if (window.netlifyIdentity) {
        window.netlifyIdentity.on('init', function(user){
          if (!user) {
            window.netlifyIdentity.on('login', function(){ document.location.reload(); });
          }
        });
      }

      // Lanza la carga del CMS
      loadCMSFromJsDelivr();
    </script>
  </body>
</html>

